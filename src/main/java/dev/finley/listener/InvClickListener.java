package dev.finley.listener;import dev.finley.HeadPlugin;import dev.finley.util.Printer;import dev.finley.util.builder.InvBuilder;import dev.finley.util.builder.ItemBuilder;import org.bukkit.ChatColor;import org.bukkit.Material;import org.bukkit.configuration.file.FileConfiguration;import org.bukkit.entity.Player;import org.bukkit.event.EventHandler;import org.bukkit.event.Listener;import org.bukkit.event.inventory.InventoryClickEvent;import org.bukkit.event.inventory.InventoryCloseEvent;import org.bukkit.inventory.InventoryView;import org.bukkit.inventory.ItemStack;import java.util.Arrays;import java.util.List;public class InvClickListener implements Listener {    private static final String GUI_PATH_SUFFIX = ".gui.";    private static final List<String> GUI_TITLE_KEYS = List.of("settings", "language", "config");    @EventHandler    public void handleInvClick(InventoryClickEvent event) {        if (!(event.getWhoClicked() instanceof Player player)) return;        HeadPlugin plugin = HeadPlugin.getInstance();        FileConfiguration messageFile = plugin.getMessageFile();        FileConfiguration configFile = plugin.getConfig();        String selectedLanguage = plugin.getLanguageManager().getSelectedLanguage();        if (selectedLanguage.isBlank()) return;        InventoryView view = event.getView();        String title = view.getTitle();        String prefix = ChatColor.translateAlternateColorCodes('&', plugin.getPrefix());        if (!title.contains(prefix)) return;        event.setCancelled(true);        String useGuiPermission = configFile.getString("permissions.useGui");        if (useGuiPermission == null || !player.hasPermission(useGuiPermission)) {            player.closeInventory(InventoryCloseEvent.Reason.PLUGIN);            return;        }        ItemStack clickedItem = event.getCurrentItem();        if (clickedItem == null || clickedItem.getItemMeta() == null) return;        String itemName = clickedItem.getItemMeta().getDisplayName();        if (itemName.isBlank()) return;        String languageGuiPath = selectedLanguage + GUI_PATH_SUFFIX;        for (String key : GUI_TITLE_KEYS) {            String guiNamePath = languageGuiPath + key + ".name";            String translatedGuiName = messageFile.getString(guiNamePath);            if (translatedGuiName == null) continue;            translatedGuiName = ChatColor.translateAlternateColorCodes('&', translatedGuiName.replace("%prefix%", prefix));            if (title.contains(translatedGuiName)) {                switch (key) {                    case "settings":                        handleSettingsClick(player, itemName, plugin, messageFile, selectedLanguage);                        break;                    case "language":                        handleLanguageClick(player, itemName, plugin, messageFile);                        break;                    case "config":                        handleConfigClick(player, itemName, plugin, messageFile, selectedLanguage);                        break;                }                return;            }        }    }    private void handleSettingsClick(Player player, String itemName, HeadPlugin plugin, FileConfiguration messageFile, String selectedLanguage) {        String settingsItemsPath = selectedLanguage + ".gui.settings.items.";        String languageItemPath = settingsItemsPath + "languageItem";        String selectedLanguageName = messageFile.getString(languageItemPath + ".name");        if (selectedLanguageName != null && !selectedLanguageName.isBlank()) {            String translatedLanguageName = ChatColor.translateAlternateColorCodes('&', selectedLanguageName);            if (itemName.equalsIgnoreCase(translatedLanguageName)) {                String languageGuiTitle = Printer.getString(messageFile, selectedLanguage + ".gui.language.name");                InvBuilder languageBuilder = new InvBuilder(languageGuiTitle, 27);                languageBuilder.setItemToAll(new ItemBuilder(Material.BLACK_STAINED_GLASS_PANE).setEmptyName("d").build());                String languageHeadsString = Printer.getString(messageFile, "languageHeads");                if (!languageHeadsString.isBlank()) {                    List<String> headList = Arrays.stream(languageHeadsString.split("!_!")).toList();                    for (int i = 0; i < headList.size(); i++) {                        String headValue = headList.get(i);                        String foundKey = findKeyByValue(messageFile, headValue);                        if (foundKey != null) {                            String[] keyParts = foundKey.split("\\.");                            if (keyParts.length > 1) {                                String languageNamePath = keyParts[1] + ".name";                                String languageDisplayName = Printer.getString(messageFile, languageNamePath);                                ItemStack headItem = new ItemBuilder(Material.PLAYER_HEAD).setName(languageDisplayName).setHead(headValue).build();                                languageBuilder.setItem(headItem, i);                            }                        }                    }                }                player.openInventory(languageBuilder.build());                return;            }        }        String configItemPath = settingsItemsPath + "configItem";        String configItemName = messageFile.getString(configItemPath + ".name");        if (configItemName != null && !configItemName.isBlank()) {            String translatedConfigItemName = ChatColor.translateAlternateColorCodes('&', configItemName);            if (itemName.contains(translatedConfigItemName)) {                String configGuiTitle = Printer.getString(messageFile, "gui.config.name", true);                InvBuilder configBuilder = new InvBuilder(configGuiTitle, 45);                configBuilder.setItemToAll(new ItemBuilder(Material.BLACK_STAINED_GLASS_PANE).setEmptyName("d").build());                String permissionsConfigPath = plugin.getConfig().getString("permissions.useCommand");                String permissionsGuiPath = plugin.getConfig().getString("permissions.useGui");                ItemStack titleItem = new ItemBuilder(Material.PAPER).setName(Printer.getString(messageFile, "gui.config.items.configItem", true)).build();                ItemStack commandItem = new ItemBuilder(Material.COMMAND_BLOCK)                        .setName(Printer.getString(messageFile, "gui.config.items.permissions.commandItem.name", true))                        .setLore(Printer.getString(messageFile, "gui.config.items.permissions.commandItem.description", true, "%permission%!_!" + permissionsConfigPath))                        .build();                ItemStack guiItem = new ItemBuilder(Material.CRAFTING_TABLE)                        .setName(Printer.getString(messageFile, "gui.config.items.permissions.guiItem.name", true))                        .setLore(Printer.getString(messageFile, "gui.config.items.permissions.guiItem.description", true, "%permission%!_!" + permissionsGuiPath))                        .build();                configBuilder.setItem(titleItem, 13);                configBuilder.setItem(commandItem, 28);                configBuilder.setItem(guiItem, 31);                player.openInventory(configBuilder.build());            }        }    }    private void handleLanguageClick(Player player, String itemName, HeadPlugin plugin, FileConfiguration messageFile) {        String cleanItemName = removeColor(itemName);        for (String language : plugin.getLanguageManager().getLanguages()) {            String languageDisplayNamePath = language + ".name";            String foundDisplayName = messageFile.getString(languageDisplayNamePath);            if (foundDisplayName == null || foundDisplayName.isBlank()) continue;            String cleanFoundDisplayName = foundDisplayName.startsWith("&") ? foundDisplayName.substring(2) : foundDisplayName;            if (cleanFoundDisplayName.equalsIgnoreCase(cleanItemName)) {                String oldLanguage = plugin.getLanguageManager().getSelectedLanguage();                if (oldLanguage.equalsIgnoreCase(language)) {                    Printer.sendPlayerMessage(player, "error.language.already");                    return;                }                plugin.getLanguageManager().setSelectedLanguage(language);                plugin.getConfig().set("settings.language", language);                plugin.saveConfig();                String oldLangName = messageFile.getString(oldLanguage + ".name");                String newLangName = messageFile.getString(language + ".name");                Printer.sendPlayerMessage(player, "success.language.set",                        "%old%!_!&c" + (oldLangName != null ? oldLangName : "N/A") + "&7",                        "%language%!_!&a" + (newLangName != null ? newLangName : "N/A") + "&7");                player.closeInventory(InventoryCloseEvent.Reason.PLUGIN);                return;            }        }    }    private void handleConfigClick(Player player, String itemName, HeadPlugin plugin, FileConfiguration messageFile, String selectedLanguage) {        String basePath = selectedLanguage + ".gui.config.items.";        if (checkConfigItem(player, itemName, messageFile, basePath + "configItem.name")) return;        if (checkConfigItem(player, itemName, messageFile, basePath + "permissions.commandItem.name")) return;        if (checkConfigItem(player, itemName, messageFile, basePath + "permissions.guiItem.name")) return;    }    private boolean checkConfigItem(Player player, String itemName, FileConfiguration messageFile, String itemPath) {        String display = messageFile.getString(itemPath);        if (display != null && itemName.equalsIgnoreCase(ChatColor.translateAlternateColorCodes('&', display))) {            String replacedItemName = removeColor(itemName);            String foundName = removeColor(Printer.getString(messageFile, itemPath));            if (replacedItemName.equalsIgnoreCase(foundName)) {                String s = switch (foundName) {                    case "Menu" -> "Gui";                    case "Configuration" -> "";                    default -> foundName;                };                if (!s.isBlank()) {                    String permission = Printer.getString(HeadPlugin.getInstance().getConfig(), "permissions.use" + s);                    if (permission.isBlank()) return false;                    player.closeInventory();                    HeadPlugin.getInstance().getChangePlayers().put(player.getUniqueId(), s + "!_!" + permission + "!_!");                    s = switch (s.toLowerCase()) {                        case "gui" -> "menu";                        default -> s.toLowerCase();                    };                    Printer.sendPlayerMessage(player, "waiting." + s);                }            }            return true;        }        return false;    }    public String findKeyByValue(FileConfiguration config, String value) {        return config.getKeys(true).stream().filter(string -> {            Object currentValue = config.get(string);            return currentValue != null && currentValue.toString().equals(value);        }).findFirst().orElse(null);    }    private String removeColor(String s) {        return s.replaceAll("ยง[0-9a-fk-or]", "").replaceAll("&[0-9a-fk-or]", "");    }}